<!DOCTYPE html>
<!--
This is an example using chains, maps, commit.
-->
<html>
<head>
  <title>React Transact Effects Example</title>
  <style>
    html, body, h1 {
      padding: 0;
      margin: 0;
    }
    .container {
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
  </style>
</head>
<body>
<div id="app"></div>
<script src="https://npmcdn.com/react@15.0.2/dist/react.js"></script>
<script src="https://npmcdn.com/react-dom@15.0.2/dist/react-dom.js"></script>
<script src="../../umd/ReactTransact.js"></script>
<script>
  const Task = ReactTransact.Task
  const taskCreator = ReactTransact.taskCreator
  const transact = ReactTransact.transact
  const RunContext = ReactTransact.RunContext
  const h = React.createElement

  // Task creators
  const k = taskCreator('ERROR', 'VALUE', x => x)
  const dec = taskCreator('ERROR', 'VALUE', x => x - 1)

  // Transforms
  const delay = (seconds) => (x) => new Promise((res) => setTimeout(() => res(x), seconds * 1000))

  // Create a HOC with transact.
  const Container = transact(
    (state, props, commit) => (
      // Reduce an array of tasks down to a single task to fork.
      // Each successively reduced actions will be committed using the `commit` function.
      [
        k(props.start), dec, dec, dec, dec, dec, dec, dec, dec, dec, dec
      ].reduce((task, next) => {
        return commit(task).chain(next).map(delay(1))
      })
    )
  )(
    // The state props is coming from RunContext.
    ({ state }) => h('div', {},
      h('h1', { className: 'container' },
        [state.value]
      )
    )
  )
  const stateReducer = (state, action) => {
    switch (action.type) {
      case 'VALUE':
        return { value: action.payload }
      default:
        return (state || {})
    }
  }
  ReactDOM.render(
    h(RunContext, { stateReducer, onResolved: (results) => console.log('Results', results) },
      h(Container, { start: 10 })
    ),
    document.getElementById('app')
  )
</script>
</body>
</html>
